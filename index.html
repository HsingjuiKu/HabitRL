<!DOCTYPE html>
<html>
<head>
  <title>Button Bounty Bonanza</title>
  <link rel="icon" href="favicon.ico">
  <!-- Import jsPsych core library and necessary plugins -->
  <script src="https://unpkg.com/jspsych@8.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@2.1.0"></script>

  <!--import jquery via google's CDN-->
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js'></script>
  

  <!-- Custom scripts -->
  <script src="static/js/endExperimentNow.js"></script>
  <script src="static/js/getTrainingBlockDef.js"></script>
  <script src="static/js/generateStimulus.js"></script>
  <script src="static/js/trainingPhase.js"></script>
  <script src="static/js/testPhase.js"></script>
  <script src="static/js/createInstructions.js"></script>
  <script src="static/js/saveData.js"></script>
  <script src="static/js/utils.js"></script>

  <!-- CSS styles for jsPsych and survey plugin -->
  <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@2.1.0/css/survey.css">
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css">
  <link rel="stylesheet" href="static/css/style.css" type="text/css">
</head>
<body>
<script>
	const jsPsych = initJsPsych();

  // Monitor tab visibility and abort experiment if participant leaves the page too many times
  let num_tab_switches = 0;
  document.addEventListener("visibilitychange",()=>{
    if (document.visibilityState === "hidden"){
      if (num_tab_switches >= 3) { 
        // Abort experiment if participant left the page more than 3 times
        console.log('Ending exp because they left too many times');
        setTimeout(function(){
          jsPsych.finishTrial();
          jsPsych.abortExperiment('The task has ended. Thank you for your participation.');
        });
      } else {
        // Warn participant if they have left but not yet exceeded the threshold
        num_tab_switches += 1; 
        console.log(`Num switches: ${num_tab_switches}`);
        alert(`Please stay on the task page! You have left ${num_tab_switches} time(s).`)
      }
    }
  });

  // Global variables
  const actions = ["A1", "A2", "A3"];
  const keys = ["f", "g", "h"];

  async function runExp() {

    // Get ID and define file name
    let subj_id = jsPsych.data.getURLVariable("id")
    if (jsPsych.data.getURLVariable("id") == undefined) {
      subj_id = `anon_${Date.now()}`;
    }
    const dateStr = (new Date()).toISOString().slice(0,10).replace(/-/g,'');
    window.fileName = `${subj_id}-${dateStr}.csv`;

    // Load files
    const response_vars = await fetch('static/vars.json');
    const designVars = await response_vars.json();
    const response_img = await fetch('static/images/images.json');
    let imgs = await response_img.json();
    const img_paths = imgs.map(img => `static/images/${img}`)

    // Create training block definition (assign conditions, stimuli, key-action mapping)
    const allTrainingBlocksDef = getTrainingBlockDef(designVars);

    // Create timeline
    let timeline = []
	  timeline.push({type: jsPsychPreload, images: img_paths});  // preload images
    timeline.push(...createFullScreenInstructions());
    timeline.push(...createInstructions());
    timeline.push(...createTrainingPhase(allTrainingBlocksDef));
    timeline.push(...createTestInstructions());
    timeline.push(...createTestPhase(designVars, allTrainingBlocksDef));
    timeline.push(...createEndInstructions(subj_id));

    // Pass timeline to jsPsych
    jsPsych.run(timeline)
  };

  runExp()

</script>
</body>
</html>
